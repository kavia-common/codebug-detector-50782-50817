---
import type { LanguageOption } from './utils';
import { DEFAULT_LANGUAGES, uid } from './utils';

interface Props {
  id?: string;
  label?: string;
  value?: string;
  options?: LanguageOption[];
  error?: string;
  hint?: string;
}

const {
  id = uid('lang'),
  label = 'Language',
  value = 'javascript',
  options = DEFAULT_LANGUAGES,
  error,
  hint,
} = Astro.props;
const hasError = Boolean(error);
const hintId = hint ? `${id}-hint` : undefined;
const errorId = hasError ? `${id}-error` : undefined;
const describedBy = [hintId, errorId].filter(Boolean).join(' ') || undefined;
---

<div class="field">
  <label class="label" for={id}>{label}</label>
  <div class="select-wrap">
    <select id={id} name="language" class={`select ${hasError ? 'invalid' : ''}`} aria-invalid={hasError ? 'true' : 'false'} aria-describedby={describedBy}>
      {
        // group by 'group'
        Array.from(new Set(options.map(o => o.group || ''))).map(group => {
          const groupOptions = options.filter(o => (o.group || '') === group);
          return group ? (
            <optgroup label={group}>
              {groupOptions.map(o => <option value={o.value} selected={o.value === value}>{o.label}</option>)}
            </optgroup>
          ) : (
            groupOptions.map(o => <option value={o.value} selected={o.value === value}>{o.label}</option>)
          );
        })
      }
    </select>
  </div>
  {hint && <p id={hintId} class="hint">{hint}</p>}
  {hasError && <p id={errorId} role="alert" class="error">{error}</p>}
</div>

<style>
  .field { display: grid; gap: 6px; }
  .label {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: .2px;
  }
  .select-wrap { position: relative; }
  .select {
    appearance: none;
    width: 100%;
    padding: 10px 36px 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--surface) 96%, var(--color-primary) 4%);
    color: var(--text);
    font-weight: 600;
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
  }
  .select:focus {
    border-color: color-mix(in oklab, var(--color-primary) 50%, var(--border));
    box-shadow: 0 0 0 4px var(--ring);
    background: color-mix(in oklab, var(--surface) 92%, var(--color-primary) 8%);
  }
  .select.invalid {
    border-color: color-mix(in oklab, var(--color-error) 60%, var(--border));
    box-shadow: 0 0 0 4px color-mix(in oklab, var(--color-error) 25%, transparent);
  }

  .hint { font-size: 12px; color: var(--text-muted); margin: 0; }
  .error { font-size: 12px; color: var(--color-error); margin: 0; font-weight: 600; }
</style>
