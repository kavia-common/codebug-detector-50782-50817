---
import { uid } from './utils';

interface Props {
  id?: string;
  label?: string;
  placeholder?: string;
  value?: string;
  error?: string;
  hint?: string;
  /**
   * Tabs/spaces settings
   */
  insertSpaces?: boolean;
  tabSize?: number;
}

const {
  id = uid('code'),
  label = 'Code',
  placeholder = 'Paste your code snippet here...',
  value = '',
  error,
  hint = 'Supports paste and file upload.',
  insertSpaces = true,
  tabSize = 2,
} = Astro.props;

const hasError = Boolean(error);
const hintId = `${id}-hint`;
const errorId = `${id}-error`;
const describedBy = [hint ? hintId : null, hasError ? errorId : null].filter(Boolean).join(' ') || undefined;
---

<div class="code-field">
  <div class="row">
    <label class="label" for={id}>{label}</label>
    <div class="settings" role="group" aria-label="Indentation settings">
      <label class="switch">
        <input id={`${id}-spaces`} type="checkbox" checked={insertSpaces} data-control="spaces" />
        <span>Insert spaces</span>
      </label>
      <label class="tabsize">
        <span class="sr-only">Tab size</span>
        <select id={`${id}-tabsize`} class="tab-select" aria-label="Tab size" data-control="tabsize">
          {[2, 4, 8].map(n => <option value={n} selected={n === tabSize}>{n} spaces</option>)}
        </select>
      </label>
    </div>
  </div>

  <textarea
    id={id}
    class={`textarea ${hasError ? 'invalid' : ''}`}
    placeholder={placeholder}
    aria-describedby={describedBy}
    aria-invalid={hasError ? 'true' : 'false'}
    spellcheck="false"
    inputmode="text"
    data-initial={value}
    ></textarea>

  {hint && <p id={hintId} class="hint">{hint}</p>}
  {hasError && <p id={errorId} role="alert" class="error">{error}</p>}
</div>

<style>
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; white-space: nowrap;
  }
  .code-field { display: grid; gap: 8px; }
  .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
  .label { font-size: 13px; font-weight: 700; letter-spacing: .2px; }
  .settings { display: flex; align-items: center; gap: 10px; }
  .switch { display: inline-flex; gap: 6px; font-size: 12px; color: var(--text-muted); align-items: center; }
  .switch input { accent-color: var(--color-primary); }
  .tabsize {}
  .tab-select {
    appearance: none;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--surface) 96%, var(--color-primary) 4%);
    color: var(--text);
    font-weight: 600;
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
  }
  .tab-select:focus {
    border-color: color-mix(in oklab, var(--color-primary) 50%, var(--border));
    box-shadow: 0 0 0 4px var(--ring);
    background: color-mix(in oklab, var(--surface) 92%, var(--color-primary) 8%);
  }

  .textarea {
    width: 100%;
    min-height: 260px;
    resize: vertical;
    padding: 12px 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--surface) 96%, var(--color-primary) 4%);
    color: var(--text);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    line-height: 1.5;
    tab-size: 2;
    white-space: pre;
    white-space: pre-wrap;
    outline: none;
    transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
  }
  .textarea:focus {
    border-color: color-mix(in oklab, var(--color-primary) 50%, var(--border));
    box-shadow: 0 0 0 4px var(--ring);
    background: color-mix(in oklab, var(--surface) 92%, var(--color-primary) 8%);
  }
  .textarea.invalid {
    border-color: color-mix(in oklab, var(--color-error) 60%, var(--border));
    box-shadow: 0 0 0 4px color-mix(in oklab, var(--color-error) 25%, transparent);
  }

  .hint { font-size: 12px; color: var(--text-muted); margin: 0; }
  .error { font-size: 12px; color: var(--color-error); margin: 0; font-weight: 600; }
</style>

<script>
  (function() {
    const root = document.currentScript?.closest('.code-field');
    if (!root) return;
    const textarea = root.querySelector('textarea');
    const spacesToggle = root.querySelector('[data-control="spaces"]');
    const tabSizeSelect = root.querySelector('[data-control="tabsize"]');

    function getTabString() {
      const insertSpaces = spacesToggle && 'checked' in spacesToggle ? spacesToggle.checked : true;
      const size = Number(tabSizeSelect && 'value' in tabSizeSelect ? tabSizeSelect.value : '2');
      return insertSpaces ? ' '.repeat(Math.max(1, Math.min(size, 8))) : '\t';
    }

    // Initialize with default value from data attribute
    const initial = textarea?.getAttribute('data-initial') || '';
    if (initial && textarea) {
      textarea.value = String(initial);
    }

    // Handle Tab key to insert spaces or tab char
    textarea?.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const el = e.target;
        const selectionStart = el.selectionStart ?? 0;
        const selectionEnd = el.selectionEnd ?? 0;
        const value = el.value ?? '';
        const tabStr = getTabString();
        el.value = value.slice(0, selectionStart) + tabStr + value.slice(selectionEnd);
        const cursor = selectionStart + tabStr.length;
        el.selectionStart = el.selectionEnd = cursor;
        el.dispatchEvent(new Event('input', { bubbles: true }));
      }
    });

    // Listen for filedrop content from FileDrop component
    document.addEventListener('filecontent', (e) => {
      const detail = e && e.detail;
      if (!detail || !textarea) return;
      textarea.value = String(detail.content || '');
      textarea.focus();
      // Announce paste
      try {
        const live = document.getElementById('global-live');
        if (live) {
          live.textContent = `Pasted content from ${detail.name || 'file'}`;
        }
      } catch {}
      textarea.dispatchEvent(new Event('input', { bubbles: true }));
    });

    // Expose simple API via custom events
    root.addEventListener('getvalue', (ev) => {
      if (!ev.detail) ev.detail = {};
      ev.detail.value = textarea ? textarea.value : '';
    });

    root.addEventListener('setvalue', (ev) => {
      const v = String((ev.detail && ev.detail.value) || '');
      if (textarea) {
        textarea.value = v;
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
      }
    });
  })();
</script>
