---
import Layout from '../layouts/Layout.astro';
import CodeInput from '../components/CodeInput.astro';
import LanguageSelector from '../components/LanguageSelector.astro';
import FileDrop from '../components/FileDrop.astro';
import AnalysisResults from '../components/AnalysisResults.astro';
---

<Layout>
  <!-- Global live region for A11y announcements -->
  <div id="global-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <section class="split">
    <!-- Code Input Panel -->
    <article class="panel" id="code-panel">
      <div class="panel-header">
        <div class="panel-title">Code Input</div>
      </div>
      <div class="panel-body">
        <div class="grid">
          <LanguageSelector id="lang-select" hint="Choose the language to improve analysis accuracy." />
          <FileDrop id="file-drop" label="Paste from file" />
        </div>

        <CodeInput id="code-editor" label="Your code" />

        <div class="controls">
          <button id="btn-analyze" class="btn btn-primary" type="button" aria-describedby="analyze-hint">Analyze</button>
          <button id="btn-clear" class="btn" type="button">Clear</button>
          <button id="btn-sample" class="btn" type="button">Load Sample</button>

          <!-- Recent snippets dropdown -->
          <div class="recent-wrap">
            <label for="recent-snippets" class="sr-only">Recent snippets</label>
            <select id="recent-snippets" class="recent-select" title="Recent snippets (last 3)" aria-label="Recent snippets">
              <option value="">Recent snippetsâ€¦</option>
            </select>
            <button id="btn-load-recent" class="btn" type="button" title="Load selected recent snippet">Load</button>
          </div>
        </div>
        <p id="analyze-hint" class="tip">Tip: In demo mode, results are simulated locally.</p>
      </div>
    </article>

    <!-- Results Panel -->
    <aside class="panel" id="results-panel">
      <div class="panel-header">
        <div class="panel-title">Results</div>
      </div>
      <div class="panel-body">
        <AnalysisResults />
      </div>
    </aside>
  </section>

  <!-- Toast container -->
  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <style>
    /* Accessibility helper */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
      margin-bottom: 10px;
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
    }

    /* Recent snippets UI */
    .recent-wrap {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-left: auto;
    }
    .recent-select {
      appearance: none;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface) 96%, var(--color-primary) 4%);
      color: var(--text);
      font-weight: 600;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
      box-shadow: var(--shadow-sm);
    }
    .recent-select:focus {
      border-color: color-mix(in oklab, var(--color-primary) 50%, var(--border));
      box-shadow: 0 0 0 4px var(--ring);
      background: color-mix(in oklab, var(--surface) 92%, var(--color-primary) 8%);
    }

    /* Toasts */
    #toast-container {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 80;
      display: grid;
      gap: 8px;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-left: 4px solid var(--color-primary);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      min-width: 200px;
      max-width: min(420px, 90vw);
      animation: toast-in .18s ease-out;
      font-size: 13px;
    }
    .toast.success { border-left-color: #10B981; } /* emerald-ish */
    .toast.error { border-left-color: var(--color-error); }
    .toast .close {
      margin-left: auto;
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      font-weight: 700;
    }
    @keyframes toast-in {
      from { transform: translateY(8px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Analyze button loading spinner */
    .btn.loading {
      position: relative;
      pointer-events: none;
      opacity: .8;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid color-mix(in oklab, var(--surface) 70%, var(--color-primary) 30%);
      border-top-color: var(--color-primary);
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
  </style>

  <script>
    import { analyze } from '../services/analysisClient';

    (function() {
      const STORAGE_KEY = 'recent-snippets:v1';
      const MAX_RECENTS = 3;

      const codeField = document.getElementById('code-editor');
      const langSelect = document.getElementById('lang-select');
      const resultsPanel = document.getElementById('results-panel');

      const btnAnalyze = document.getElementById('btn-analyze');
      const btnClear = document.getElementById('btn-clear');
      const btnSample = document.getElementById('btn-sample');

      const recentSelect = document.getElementById('recent-snippets');
      const btnLoadRecent = document.getElementById('btn-load-recent');

      const toastContainer = document.getElementById('toast-container');

      // State management
      let currentState = 'idle'; // 'idle' | 'loading' | 'error' | 'ready'
      function setState(next, payload = {}) {
        currentState = next;
        // Update AnalysisResults island
        const el = document.getElementById('analysis-results');
        if (el) {
          const evt = new CustomEvent('analysis:update', { detail: { state: next, ...payload }, bubbles: true });
          el.dispatchEvent(evt);
        }
        // Toggle loading styles on analyze button
        if (btnAnalyze) {
          if (next === 'loading') {
            btnAnalyze.classList.add('loading');
            btnAnalyze.setAttribute('disabled', 'true');
            btnAnalyze.textContent = 'Analyzing...';
          } else {
            btnAnalyze.classList.remove('loading');
            btnAnalyze.removeAttribute('disabled');
            btnAnalyze.textContent = 'Analyze';
          }
        }
      }

      // Toasts
      function showToast(message, type = 'success') {
        if (!toastContainer) return;
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        const btn = document.createElement('button');
        btn.className = 'close';
        btn.type = 'button';
        btn.setAttribute('aria-label', 'Dismiss notification');
        btn.textContent = 'âœ•';
        btn.addEventListener('click', () => t.remove());

        const span = document.createElement('span');
        span.textContent = message;

        t.appendChild(span);
        t.appendChild(btn);
        toastContainer.appendChild(t);

        // Auto-dismiss after 4s
        setTimeout(() => t.remove(), 4000);
      }

      // Code/Language getters & setters
      function getCodeValue() {
        const ev = new CustomEvent('getvalue', { detail: { value: '' }, bubbles: true, cancelable: false });
        codeField?.dispatchEvent(ev);
        // @ts-ignore
        return ev.detail.value || '';
      }
      function setCodeValue(v) {
        const ev = new CustomEvent('setvalue', { detail: { value: v }, bubbles: true, cancelable: false });
        codeField?.dispatchEvent(ev);
      }
      function getLanguageValue() {
        const sel = (langSelect?.querySelector('select'));
        return sel?.value || 'javascript';
      }
      function setLanguageValue(lang) {
        const sel = (langSelect?.querySelector('select'));
        if (sel) sel.value = lang;
      }

      // Recent snippets persistence
      function loadRecents() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      }
      function saveRecents(list) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list.slice(0, MAX_RECENTS)));
        } catch {}
      }
      function addRecent(snippet, language) {
        const clean = (snippet || '').trim();
        if (!clean) return;
        const now = Date.now();
        const recents = loadRecents();
        // De-dup by content+lang
        const filtered = recents.filter(r => !(r.snippet === clean && r.language === language));
        filtered.unshift({ snippet: clean, language, ts: now });
        saveRecents(filtered);
        populateRecentSelect();
      }
      function populateRecentSelect() {
        if (!recentSelect) return;
        const recents = loadRecents();
        // Reset options
        recentSelect.innerHTML = '';
        const baseOpt = document.createElement('option');
        baseOpt.value = '';
        baseOpt.textContent = 'Recent snippetsâ€¦';
        recentSelect.appendChild(baseOpt);

        recents.forEach((r, idx) => {
          const opt = document.createElement('option');
          opt.value = String(idx);
          const preview = r.snippet.split('\n')[0].slice(0, 48).replace(/\s+/g, ' ');
          opt.textContent = `${r.language} â€¢ ${preview}${r.snippet.length > 48 ? 'â€¦' : ''}`;
          recentSelect.appendChild(opt);
        });
      }

      // Validation
      function validateInput(code, language) {
        if (!language || typeof language !== 'string') {
          return 'Please select a language.';
        }
        if (!code || !code.trim()) {
          return 'Please paste code before analyzing.';
        }
        if (code.length > 200_000) {
          return 'Snippet is too large to analyze. Please reduce its size.';
        }
        return null;
      }

      // Initial setup
      populateRecentSelect();
      setState('idle');

      // Interactions
      btnAnalyze?.addEventListener('click', async () => {
        const code = getCodeValue();
        const language = getLanguageValue();

        const validationError = validateInput(code, language);
        if (validationError) {
          setState('error', { response: { findings: [], summary: { total: 0, bySeverity: { info:0, low:0, medium:0, high:0, critical:0 } } }, errorMessage: validationError });
          showToast(validationError, 'error');
          const live = document.getElementById('global-live');
          if (live) live.textContent = validationError;
          return;
        }

        setState('loading');

        try {
          const res = await analyze(code, language);
          if (res?.error) {
            setState('error', { response: res, errorMessage: res.error.message || 'Analysis failed' });
            showToast(res.error.message || 'Analysis failed', 'error');
          } else {
            setState('ready', { response: res });
            showToast('Analysis complete', 'success');
            // persist recent
            addRecent(code, language);
          }
        } catch (e) {
          setState('error', { response: { findings: [], summary: { total: 0, bySeverity: { info:0, low:0, medium:0, high:0, critical:0 } } }, errorMessage: 'Unexpected error during analysis' } );
          showToast('Unexpected error during analysis', 'error');
        }
      });

      btnClear?.addEventListener('click', () => {
        setCodeValue('');
        setState('idle', { response: { findings: [], summary: { total: 0, bySeverity: { info:0, low:0, medium:0, high:0, critical:0 } } } });
      });

      btnSample?.addEventListener('click', () => {
        const sample = `// Sample: risky JavaScript
function run(code) {
  // TODO: tighten security
  var result = eval(code); // intentionally risky
  return result;
}
`;
        setCodeValue(sample);
        showToast('Loaded sample code', 'success');
        const live = document.getElementById('global-live');
        if (live) live.textContent = 'Loaded sample code into editor.';
      });

      btnLoadRecent?.addEventListener('click', () => {
        if (!recentSelect) return;
        const idx = Number(recentSelect.value);
        if (!Number.isFinite(idx) || idx < 0) {
          showToast('Select a recent snippet first', 'error');
          return;
        }
        const recents = loadRecents();
        const item = recents[idx];
        if (!item) {
          showToast('Unable to load the selected snippet', 'error');
          return;
        }
        setLanguageValue(item.language);
        setCodeValue(item.snippet);
        showToast('Loaded recent snippet', 'success');
        const live = document.getElementById('global-live');
        if (live) live.textContent = 'Loaded recent snippet into editor.';
      });

      // Wire island update handling
      (function wireIslandUpdates() {
        const el = document.getElementById('analysis-results');
        if (!el) return;

        el.addEventListener('analysis:update', (e) => {
          const detail = e && (e as CustomEvent).detail || {};
          const state = detail.state || 'idle';
          const response = detail.response || null;
          const errorMessage = detail.errorMessage || null;

          // Update attribute for CSS/logic
          el.setAttribute('data-state', state);

          // Rebuild the list content region if present
          const listRegion = el.querySelector('#results-list');
          if (!listRegion) return;

          function textEl(cls, title, text) {
            const wrap = document.createElement('div');
            wrap.className = cls;
            if (cls === 'loading') {
              wrap.innerHTML = '<div class="spinner" aria-hidden="true"></div><div class="text"></div>';
              wrap.querySelector('.text').textContent = text;
            } else if (cls === 'error-card') {
              wrap.innerHTML = '<div class="error-title"></div><div class="error-text"></div>';
              wrap.querySelector('.error-title').textContent = title;
              wrap.querySelector('.error-text').textContent = text;
            } else if (cls === 'placeholder') {
              wrap.innerHTML = `<div class="icon" aria-hidden="true">ðŸ”Ž</div><div class="title"></div><div class="text"></div>`;
              wrap.querySelector('.title').textContent = title;
              wrap.querySelector('.text').textContent = text;
            }
            return wrap;
          }

          // Update summary chips
          const totalChip = el.querySelector('.chip.total strong');
          const sevChips = el.querySelectorAll('.chip.sev');
          const sevOrder = ['critical','high','medium','low','info'];
          if (response && response.summary) {
            if (totalChip) totalChip.textContent = String(response.summary.total);
            sevChips.forEach((chip) => {
              const label = chip.textContent || '';
              const found = sevOrder.find(s => label && label.toLowerCase().includes(`${s}`));
              if (found) {
                chip.textContent = `${found}: ${response.summary.bySeverity[found]}`;
              }
            });
          } else {
            if (totalChip) totalChip.textContent = '0';
            sevChips.forEach((chip) => {
              const label = chip.textContent || '';
              const found = sevOrder.find(s => label && label.toLowerCase().includes(`${s}`));
              if (found) chip.textContent = `${found}: 0`;
            });
          }

          // Clear current content
          listRegion.innerHTML = '';

          if (state === 'idle') {
            listRegion.appendChild(textEl('placeholder', 'No analysis yet', 'Run â€œAnalyzeâ€ to see potential bugs and suggestions here.'));
            return;
          }
          if (state === 'loading') {
            listRegion.appendChild(textEl('loading', '', 'Analyzing your codeâ€¦'));
            return;
          }
          if (state === 'error') {
            listRegion.appendChild(textEl('error-card', 'Error', errorMessage || (response?.error?.message || 'Unexpected error')));
            return;
          }
          const findings = response?.findings || [];
          if (!findings.length) {
            listRegion.appendChild(textEl('placeholder', 'No findings', 'No issues detected.'));
            return;
          }

          // Render findings list
          const ul = document.createElement('ul');
          ul.className = 'list';
          function sevColor(sev) {
            switch (sev) {
              case 'critical': return getComputedStyle(document.documentElement).getPropertyValue('--color-error') || 'crimson';
              case 'high': return 'color-mix(in oklab, var(--color-error) 70%, var(--text))';
              case 'medium': return 'color-mix(in oklab, var(--color-primary) 60%, var(--text))';
              case 'low': return 'color-mix(in oklab, var(--color-primary) 40%, var(--text-muted))';
              default: return 'var(--text-muted)';
            }
          }
          findings.forEach((f) => {
            const li = document.createElement('li');
            li.className = 'item';
            li.setAttribute('data-severity', f.severity);
            li.setAttribute('data-id', f.id);

            li.innerHTML = `
              <div class="item-head">
                <span class="sev-chip ${f.severity}" style="--sev:${sevColor(f.severity)}">${f.severity}</span>
                <div class="item-title"></div>
                <div class="item-actions">
                  <button class="icon-btn" data-action="copy" title="Copy finding" aria-label="Copy finding">ðŸ“‹</button>
                  <button class="icon-btn" data-action="share" title="Share link to finding" aria-label="Share finding">ðŸ”—</button>
                  <button class="icon-btn" data-action="toggle" title="Show details" aria-label="Toggle details" aria-expanded="false">âž¤</button>
                </div>
              </div>
              <div class="meta">
                <span class="meta-pill"><strong>Rule:</strong> ${f.rule}</span>
                <span class="meta-pill"><strong>Lines:</strong> ${f.lineStart}${f.lineEnd !== f.lineStart ? `â€“${f.lineEnd}` : ''}</span>
              </div>
              <div class="desc"></div>
              <details class="details">
                <summary>Recommendation</summary>
                <div class="rec"></div>
              </details>
            `;
            const t = li.querySelector('.item-title'); if (t) t.textContent = f.title;
            const d = li.querySelector('.desc'); if (d) d.textContent = f.description;
            const r = li.querySelector('.rec'); if (r) r.textContent = f.recommendation;
            ul.appendChild(li);
          });
          listRegion.appendChild(ul);

          // Ensure active filter reapplies
          const active = el.querySelector('.filter-chip.active');
          const sev = active?.getAttribute('data-filter') || 'all';
          const items = el.querySelectorAll('.item');
          items.forEach((it) => {
            const s = it.getAttribute('data-severity') || 'info';
            const show = (sev === 'all') || (s === sev);
            (it).style.display = show ? '' : 'none';
          });
        });
      })();
    })();
  </script>
</Layout>
